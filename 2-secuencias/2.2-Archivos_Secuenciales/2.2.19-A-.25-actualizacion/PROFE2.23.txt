ACCION 2.2.23 ES
AMBIENTE
	FECHA:REGISTRO
		AÑO:N(4)
		MES:1..12
		DIA:1..31
	FIN REGISTRO
	FORMATO_CLIENTE=REGISTRO
		ID_CASA:N(4)
		FECHA_ULT_LECTURA:FECHA
		CANT_LECTURAS:N(4)
		PROM_LECTURAS:N(10)
		TIPO_CONSUMIDOR:("A","B","C")
	FIN REGISTRO
	FORMATO_MEDICIONES=REGISTRO
		ID_CASA:N(4)
		FECHA_MEDICION:FECHA
		CONSUMO:N(6)
	FIN REGISTRO
	CLIENTE:ARCHIVO DE FORMATO_CLIENTE ORDENADO POR ID_CASA
	SALIDA:ARCHIVO DE FORMATO_CLIENTE ORDENADO POR ID_CASA
	MEDICIONES:ARCHIVO DE FORMATO_MEDICIONES ORDENADO POR ID_CASA
	MAE:FORMATO_CLIENTE
	MOV:FORMATO_MEDICIONES

	PROCEDIMIENTO LEER_CLIENTE ES:
		LEER(CLIENTE, MAE)
		SI FDA(CLIENTE) ENTONCES
			MAE.ID_CASA:=HV
		FIN SI
	FIN PROCEDIMIENTO
	PROCEDIMIENTO LEER_MEDICIONES ES:
		LEER(MEDICIONES, MOV)
		SI FDA(MEDICIONES) ENTONCES
			MOV.ID_CASA:=HV
		FIN SI
	FIN PROCEDIMIENTO
INICIO
	ABRIR/E(CLIENTE)
	ABRIR/E(MEDICIONES)
	ABRIR/S(SALIDA)
	LEER_MEDICIONES
	LEER_CLIENTE
	MIENTRAS (MAE.ID_CASA <> HV) o (MOV.ID_CASA) HACER
		SI (MAE.ID_CASA < MOV.ID_CASA) ENTONCES
			GRABAR(SALIDA,MAE)
			LEER_CLIENTE
		SiNO
			SI (MAE.ID_CASA = MOV.ID_CASA) ENTONCES
				MIENTRAS (MAE.ID_CASA = MOV.ID_CASA) HACER
					SI (MOV.FECHA_MEDICION.AÑO < 2015) O 
						((MOV.FECHA_MEDICION.AÑO = 2015) Y (MOV.FECHA_MEDICION.MES = 1) ENTONCES
						MAE.PRMEDIO := (MAE.CANT_LECTURAS * MAE.PROMEDIO) + MOV.CONSUMO/  MAE.CANT_LECUTRAS + 1
						MAE.CANT_LECUTRAS := MAE.CANT_LECUTRAS + 1
						MAE.FECHA_ULT_LECTURA := MOV.FECHA_MEDICION
					FIN SI
					LEER_MEDICIONES
				FIN MIENTRAS
				SEGUN MAE.PROMEDIO HACER
					<20: MAE.TIPO_CONSUMIDOR:= 'A'
					<40: MAE.TIPO_CONSUMIDOR:= 'B'
					OTRO: MAE.TIPO_CONSUMIDOR:= 'C'
				FIN SEGUN
				GRABAR(SALIDA,MAE)
				LEER_CLIENTE
			SiNO
				MAE.ID_CASA := MOV.ID_CASA
				MAE.FECHA_ULT_LECTURA := MOV.FECHA_MEDICION
				MAE.CANT_LECUTRAS := 1
				MAE.PROMEDIO := MOV.CONSUMO
				LEER_MEDICIONES
				MIENTRAS (MAE.ID_CASA = MOV.ID_CASA) HACER
					SI (MOV.FECHA_MEDICION.AÑO < 2015) O 
						((MOV.FECHA_MEDICION.AÑO = 2015) Y (MOV.FECHA_MEDICION.MES = 1) ENTONCES
						MAE.PRMEDIO := (MAE.CANT_LECTURAS * MAE.PROMEDIO) + MOV.CONSUMO/  MAE.CANT_LECUTRAS + 1
						MAE.CANT_LECUTRAS := MAE.CANT_LECUTRAS + 1
						MAE.FECHA_ULT_LECTURA := MOV.FECHA_MEDICION
					FIN SI
					LEER_MEDICIONES
				FIN MIENTRAS
				SEGUN MAE.PROMEDIO HACER
					<20: MAE.TIPO_CONSUMIDOR:= 'A'
					<40: MAE.TIPO_CONSUMIDOR:= 'B'
					OTRO: MAE.TIPO_CONSUMIDOR:= 'C'
				FIN SEGUN
				GRABAR(SALIDA,MAE)
			FIN SI
		FIN SI
	FIN MIENTRAS

	CERRAR

FIN ACCION


